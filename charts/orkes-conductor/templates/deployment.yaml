{{- $securityEnabled := eq (toString .Values.security.enabled) "true" -}}
{{- $clusterMode := eq (toString (include "orkes-conductor.redis.clusterMode" .)) "true" -}}
{{- $enableCustomTrustStore := or (eq (toString .Values.trustStore.enabled) "true") (eq (toString .Values.enableCustomTrustStore) "true") -}}
{{- $vaultEnabled := and (include "orkes-conductor.vault.enabled" . | eq "true") (or (include "orkes-conductor.vault.server.enabled" . | eq "true") (include "orkes-conductor.vault.workers.enabled" . | eq "true")) -}}
{{- if $securityEnabled -}}
  {{- $validation := .Values.security.defaultUserEmail | required "security.defaultUserEmail is required." -}}
  {{- $validation := .Values.security.defaultUserName | required "security.defaultUserName is required." -}}
  {{- if not $vaultEnabled -}}
    {{- $validation := .Values.security.jwt.secret | required "security.jwt.secret is required (unless using Vault)." -}}
    {{- $validation := include "orkes-conductor.workers.accessKeyId" . | required "workers.auth.accessKeyId or workersConfig.accessKeyId is required (unless using Vault)." -}}
    {{- $validation := include "orkes-conductor.workers.accessKeySecret" . | required "workers.auth.accessKeySecret or workersConfig.accessKeySecret is required (unless using Vault)." -}}
  {{- end -}}
  {{- if and .Values.security.auth0 .Values.security.auth0.enabled -}}
    {{- $validation := .Values.security.auth0.clientId | required "security.auth0.clientId is required." -}}
    {{- $validation := .Values.security.auth0.domain | required ".security.auth0.domain is required." -}}
    {{- if eq (toString .Values.security.auth0.useIdToken) "false" -}}
      {{- $validation := .Values.security.auth0.clientSecret | required "security.auth0.clientSecret is required if useIdToken is false." -}}
    {{- end -}}
  {{- end -}}
  {{- if and .Values.security.oidc .Values.security.oidc.enabled -}}
    {{- $validation := .Values.security.oidc.clientId | required "security.oidc.clientId is required." -}}
    {{- $validation := .Values.security.oidc.audience | required "security.oidc.audience is required." -}}
    {{- $validation := .Values.security.oidc.metadataUrl | required "security.oidc.metadataUrl is required." -}}
  {{- end -}}
  {{- if and .Values.security.okta .Values.security.okta.enabled -}}
    {{- $validation := .Values.security.okta.clientId | required "security.okta.clientId is required." -}}
    {{- $validation := .Values.security.okta.audience | required "security.okta.audience is required." -}}
    {{- $validation := .Values.security.okta.issuer | required "security.okta.issuer is required." -}}
  {{- end -}}
{{- end -}}
{{- if eq .Values.app.archiveStoreType "s3" -}}
  {{- $validation := .Values.app.documentStoreS3BucketName | required "app.documentStoreS3BucketName is required." -}}
{{- end -}}
{{- if eq .Values.app.archiveStoreType "azureblob" -}}
  {{- $validation := .Values.app.documentStoreAzureBlobContainerName | required "app.documentStoreAzureBlobContainerName is required." -}}
  {{- $validation := .Values.app.documentStoreAzureBlobEndpoint | required "app.documentStoreAzureBlobEndpoint is required." -}}
  {{- $validation := .Values.app.documentStoreAzureUseSASToken | required "app.documentStoreAzureUseSASToken is required." -}}
{{- end -}}
{{- $redisHost := include "orkes-conductor.redis.host" . -}}
{{- $redisPort := include "orkes-conductor.redis.port" . -}}
{{- $redisPassword := include "orkes-conductor.redis.password" . -}}
{{- $redisZone := include "orkes-conductor.redis.zoneSuffix" . -}}
{{- $redisHosts := printf "%v:%v:%v" $redisHost $redisPort $redisZone -}}
{{- if $redisPassword -}}
  {{- $redisHosts = printf "%v:%v" $redisHosts $redisPassword -}}
{{- end -}}
{{- $redisSslEnabledStr := include "orkes-conductor.redis.ssl" . -}}
{{- $redisSslEnabled := eq $redisSslEnabledStr "true" -}}
{{- $redisUriScheme := $redisSslEnabled | ternary "rediss" "redis" -}}
{{- $redisLockServerAddress := printf "%v://%v:%v" $redisUriScheme $redisHost $redisPort -}}
{{- $postgresUrl := include "orkes-conductor.postgres.url" . -}}
{{- if not $postgresUrl -}}
  {{- $postgresHost := include "orkes-conductor.postgres.host" . -}}
  {{- $postgresPort := include "orkes-conductor.postgres.port" . -}}
  {{- $postgresDatabase := include "orkes-conductor.postgres.database" . -}}
  {{- if and $postgresHost $postgresDatabase -}}
    {{- $sslMode := "" -}}
    {{- if eq (include "orkes-conductor.postgres.ssl.enabled" .) "true" -}}
      {{- $sslMode = printf "&sslmode=%s" (include "orkes-conductor.postgres.ssl.mode" .) -}}
    {{- end -}}
    {{- $postgresUrl = printf "jdbc:postgresql://%s:%v/%s?%s" $postgresHost $postgresPort $postgresDatabase $sslMode -}}
  {{- end -}}
{{- end -}}
{{- /*
  The variables below exist for backwards compatibility and helper consolidation
*/}}
{{- $serverReplicas := include "orkes-conductor.server.replicas" . -}}
{{- $workersReplicas := include "orkes-conductor.workers.replicas" . -}}
{{- $postgresUsername := include "orkes-conductor.postgres.username" . -}}
{{- $postgresPassword := include "orkes-conductor.postgres.password" . -}}
{{- $redisUsername := include "orkes-conductor.redis.username" . -}}
{{- $redisDbIndex := include "orkes-conductor.redis.dbIndex" . -}}
{{- $secretsType := .Values.secrets.type | default .Values.app.secretsType | default "memory" -}}
{{- $useCloudSecrets := or (eq $secretsType "gcp") (or (eq $secretsType "ssm") (eq $secretsType "azkv")) -}}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "orkes-conductor-server.fullname" . }}
  labels:
    {{- include "orkes-conductor.labels" . | nindent 4 }}
    {{- with .Values.global.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  replicas: {{ $serverReplicas }}
  selector:
    matchLabels:
      {{- include "orkes-conductor.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      annotations:
        prometheus.io/path: /actuator/prometheus
        prometheus.io/port: "8080"
        prometheus.io/scrape: "true"
        {{- $vaultServerEnabled := or (and .Values.global.vault.enabled .Values.global.vault.server.enabled) (and .Values.vault.enabled .Values.vault.server.enabled) -}}
        {{- if $vaultServerEnabled }}
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/agent-inject-status: "update"
        vault.hashicorp.com/role: {{ include "orkes-conductor.vault.server.role" . | quote }}
        vault.hashicorp.com/agent-pre-populate-only: "false"
        {{- $mergedEnvSecrets := include "orkes-conductor.vault.server.getMergedEnvSecrets" . | fromYaml -}}
        {{- range $envVar, $secretPath := $mergedEnvSecrets }}
        {{- $parts := splitList "#" $secretPath }}
        {{- $path := index $parts 0 }}
        {{- $key := index $parts 1 }}
        {{- $actualEnvVar := $envVar }}
        {{- if eq $envVar "POSTGRES_PASSWORD" }}
          {{- $actualEnvVar = "spring.datasource.password" }}
        {{- else if eq $envVar "POSTGRES_USERNAME" }}
          {{- $actualEnvVar = "spring.datasource.username" }}
        {{- else if eq $envVar "POSTGRES_URL" }}
          {{- $actualEnvVar = "spring.datasource.url" }}
        {{- else if eq $envVar "REDIS_PASSWORD" }}
          {{- $actualEnvVar = "conductor.redis.password" }}
        {{- else if eq $envVar "REDIS_LOCK_SERVER_PASSWORD" }}
          {{- $actualEnvVar = "conductor.redis-lock.serverPassword" }}
        {{- else if eq $envVar "REDIS_HOSTS" }}
          {{- $actualEnvVar = "conductor.redis.hosts" }}
        {{- else if eq $envVar "REDIS_LOCK_SERVER_ADDRESS" }}
          {{- $actualEnvVar = "conductor.redis-lock.serverAddress" }}
        {{- else if eq $envVar "REDIS_USERNAME" }}
          {{- $actualEnvVar = "conductor.redis.user" }}
        {{- else if eq $envVar "JWT_SECRET" }}
          {{- $actualEnvVar = "conductor.security.jwt.secret" }}
        {{- end }}
        vault.hashicorp.com/agent-inject-secret-{{ $envVar }}: {{ $path | quote }}
        vault.hashicorp.com/agent-inject-template-{{ $envVar }}: |
          {{`{{- with secret `}}{{ $path | quote }}{{` -}}
          export `}}{{ $actualEnvVar }}{{`="{{ .Data.data.`}}{{ $key }}{{` }}"
          {{- end -}}`}}
        {{- end }}
        {{- $mergedAnnotations := include "orkes-conductor.vault.server.getMergedAnnotations" . | fromYaml -}}
        {{- if $mergedAnnotations }}
        {{- toYaml $mergedAnnotations | nindent 8 }}
        {{- end }}
        {{- end }}
      labels:
        {{- include "orkes-conductor.selectorLabels" . | nindent 8 }}
    spec:
      containers:
        - env:
            #### Env ####
            - name: cloud.env
              value: {{ .Values.app.env }}
            - name: gcp.project.name
              value: {{ .Values.app.gcpProjectName }}
            - name: DEPLOY_ENV
              value: prod
            - name: aws.region
              value: {{ .Values.app.s3Region | quote }}
            - name: JVM_MEMORY_SETTINGS
              value: {{ .Values.app.jvmSettings | quote }}
            - name: SPRING_PROFILES_ACTIVE
              value: {{ printf "%s%s" (ternary "security," "" $securityEnabled) .Values.app.springProfilesActive | quote }}
            {{- if .Values.azureKeyVaultName }}
            - name: azure.keyvault.name
              value: {{ .Values.azureKeyVaultName | quote }}
            {{- end }}
            #### Redis ####
            {{- $vaultServerEnabled := or (and .Values.global.vault.enabled .Values.global.vault.server.enabled) (and .Values.vault.enabled .Values.vault.server.enabled) -}}
            {{- if $vaultServerEnabled }}
            {{- if not (include "orkes-conductor.vault.server.hasEnvSecret" (dict "root" . "key" "REDIS_HOSTS")) }}
            - name: conductor.redis.hosts
              value: {{ $redisHosts | quote }}
            {{- end }}
            {{- else if $useCloudSecrets }}
            - name: conductor.redis.hosts
              value: {{ $redisHosts | quote }}
            {{- else }}
            - name: conductor.redis.hosts
              valueFrom:
                secretKeyRef:
                  name: orkesdeploymentsecrets
                  key: redisHosts
            {{- end }}
            - name: conductor.redis.ssl
              value: {{ $redisSslEnabledStr | quote }}
            {{- if not (and $vaultServerEnabled (include "orkes-conductor.vault.server.hasEnvSecret" (dict "root" . "key" "REDIS_LOCK_SERVER_ADDRESS"))) }}
            - name: conductor.redis-lock.serverAddress
              value: {{ $redisLockServerAddress | quote }}
            {{- end }}
            - name: conductor.redis.database
              value: {{ $redisDbIndex | quote }}
            {{- if $redisPassword }}
            {{- if $vaultServerEnabled }}
            {{- if not (include "orkes-conductor.vault.server.hasEnvSecret" (dict "root" . "key" "REDIS_PASSWORD")) }}
            - name: conductor.redis.password
              value: {{ $redisPassword | quote }}
            {{- end }}
            {{- if not (include "orkes-conductor.vault.server.hasEnvSecret" (dict "root" . "key" "REDIS_LOCK_SERVER_PASSWORD")) }}
            - name: conductor.redis-lock.serverPassword
              value: {{ $redisPassword | quote }}
            {{- end }}
            {{- else if $useCloudSecrets }}
            - name: conductor.redis.password
              value: {{ $redisPassword | quote }}
            - name: conductor.redis-lock.serverPassword
              value: {{ $redisPassword | quote }}
            {{- else }}
            - name: conductor.redis.password
              valueFrom:
                secretKeyRef:
                  name: orkesdeploymentsecrets
                  key: redisPassword
            - name: conductor.redis-lock.serverPassword
              valueFrom:
                secretKeyRef:
                  name: orkesdeploymentsecrets
                  key: redisPassword
            {{- end }}
            {{- end }}
            {{- if $clusterMode }}
            - name: conductor.db.type
              value: redis_cluster
            - name: conductor.queue.type
              value: redis_cluster
            {{- end }}
            {{- if $redisUsername }}
            {{- if and $vaultServerEnabled (include "orkes-conductor.vault.server.hasEnvSecret" (dict "root" . "key" "REDIS_USERNAME")) }}
            {{- /* REDIS_USERNAME will be injected from Vault */ -}}
            {{- else }}
            - name: conductor.redis.user
              value: {{ $redisUsername | quote }}
            {{- end }}
            {{- end }}
            #### Postgres ####
            - name: conductor.persistence.type
              value: {{ .Values.conductor.persistence.type | quote }}
            {{- if and $vaultServerEnabled (include "orkes-conductor.vault.server.hasEnvSecret" (dict "root" . "key" "POSTGRES_URL")) }}
            {{- /* POSTGRES_URL will be injected from Vault */ -}}
            {{- else }}
            - name: spring.datasource.url
              value: {{ $postgresUrl | quote }}
            {{- end }}
            {{- if eq (include "orkes-conductor.postgres.ssl.enabled" .) "true" }}
            - name: spring.datasource.hikari.data-source-properties.ssl
              value: "true"
            - name: spring.datasource.hikari.data-source-properties.sslmode
              value: {{ include "orkes-conductor.postgres.ssl.mode" . | quote }}
            {{- end }}
            {{- $postgresMaxPoolSize := include "orkes-conductor.postgres.maxPoolSize" . -}}
            {{- if $postgresMaxPoolSize }}
            - name: spring.datasource.hikari.maximum-pool-size
              value: {{ $postgresMaxPoolSize | quote }}
            {{- end }}
            {{- $postgresMinPoolSize := include "orkes-conductor.postgres.minPoolSize" . -}}
            {{- if $postgresMinPoolSize }}
            - name: spring.datasource.hikari.minimum-idle
              value: {{ $postgresMinPoolSize | quote }}
            {{- end }}
            {{- $postgresConnectionTimeout := include "orkes-conductor.postgres.connectionTimeout" . -}}
            {{- if $postgresConnectionTimeout }}
            - name: spring.datasource.hikari.connection-timeout
              value: {{ $postgresConnectionTimeout | quote }}
            {{- end }}
            {{- if $vaultServerEnabled }}
            {{- if not (include "orkes-conductor.vault.server.hasEnvSecret" (dict "root" . "key" "POSTGRES_PASSWORD")) }}
            - name: spring.datasource.password
              value: {{ $postgresPassword | quote }}
            {{- end }}
            {{- else if $useCloudSecrets }}
            - name: spring.datasource.password
              value: {{ $postgresPassword | quote }}
            {{- else }}
            - name: spring.datasource.password
              valueFrom:
                secretKeyRef:
                  name: orkesdeploymentsecrets
                  key: postgresPassword
            {{- end }}
            {{- if and $vaultServerEnabled (include "orkes-conductor.vault.server.hasEnvSecret" (dict "root" . "key" "POSTGRES_USERNAME")) }}
            {{- /* POSTGRES_USERNAME will be injected from Vault */ -}}
            {{- else }}
            - name: spring.datasource.username
              value: {{ $postgresUsername | quote }}
            {{- end }}
            {{- if .Values.app.customLogoUrl }}
            - name: conductor.ui.custom.logo
              value: {{ .Values.app.customLogoUrl | quote }}
            {{- end }}
            {{- if $securityEnabled }}
            #### Security ####
            - name: conductor.security.enabled
              value: "true"
            - name: conductor.security.default.overwrite
              value: {{ .Values.security.overwriteDefault | quote }}
            - name: conductor.security.default.users.0.email
              value: {{ .Values.security.defaultUserEmail | quote }}
            - name: conductor.security.default.users.0.name
              value: {{ .Values.security.defaultUserName | quote }}
            - name: conductor.security.default.users.0.role
              value: "ADMIN"
            - name: conductor.security.default.createUserOnAuthentication
              value: {{ .Values.security.createUserOnAuthentication | quote }}
            - name: conductor.security.allowed-origins
              value: {{ .Values.security.allowedOrigins | quote }}
            - name: conductor.security.default.defaultUserGroupsOnCreate
              value: {{ .Values.security.defaultUserGroupsOnCreate | quote }}
            - name: conductor.security.default.workers.accessKeyId
              value: {{ include "orkes-conductor.workers.accessKeyId" . | quote }}
            - name: conductor.security.default.workers.accessKeySecret
              value: {{ include "orkes-conductor.workers.accessKeySecret" . | quote }}
            {{- if .Values.security.jwtExpiry }}
            - name: conductor.security.jwt.exp
              value: {{ .Values.security.jwtExpiry | quote }}
            {{- end }}
            {{- if $useCloudSecrets }}
            - name: conductor.security.jwt.secret
              value: {{ .Values.security.jwt.secret | quote }}
            {{- else }}
            - name: conductor.security.jwt.secret
              valueFrom:
                secretKeyRef:
                  name: orkesdeploymentsecrets
                  key: securityJwtSecret
            {{- end }}
            {{- if .Values.security.auth0 }}
            #### Security - Auth0 ####
            - name: conductor.security.auth0.clientId
              value: {{ .Values.security.auth0.clientId | quote }}
            {{- if .Values.security.auth0.clientSecret }}
            {{- if $useCloudSecrets }}
            - name: conductor.security.auth0.clientSecret
              value: {{ .Values.security.auth0.clientSecret | quote }}
            {{- else }}
            - name: conductor.security.auth0.clientSecret
              valueFrom:
                secretKeyRef:
                  name: orkesdeploymentsecrets
                  key: auth0ClientSecret
            {{- end }}
            {{- end }}
            - name: conductor.security.auth0.useIdToken
              value: {{ ne (toString .Values.security.auth0.useIdToken) "false" | quote }}
            - name: conductor.security.auth0.domain
              value: {{ .Values.security.auth0.domain | quote }}
            {{- end }}
            {{- if .Values.security.oidc }}
            #### Security - OIDC ####
            - name: conductor.security.oidc.clientId
              value: {{ .Values.security.oidc.clientId | quote }}
            - name: conductor.security.oidc.audience
              value: {{ .Values.security.oidc.audience | quote }}
            - name: conductor.security.oidc.metadataUrl
              value: {{ .Values.security.oidc.metadataUrl | quote }}
            - name: conductor.security.oidc.claims.email
              value: {{ .Values.security.oidc.emailClaim | quote }}
            {{- end }}
            {{- if .Values.security.okta }}
            #### Security - OKTA ####
            - name: conductor.security.okta.clientId
              value: {{ .Values.security.okta.clientId | quote }}
            - name: conductor.security.okta.audience
              value: {{ .Values.security.okta.audience | quote }}
            - name: conductor.security.okta.issuer
              value: {{ .Values.security.okta.issuer | quote }}
            - name: conductor.security.okta.useInteractionCodeFlow
              value: {{ .Values.security.okta.useInteractionCodeFlow | quote }}
            {{- if .Values.security.okta.idpConf }}
            - name: conductor.security.okta.idpConf
              value: {{ .Values.security.okta.idpConf }}
            {{- end }}
            {{- if .Values.security.okta.sync }}
            - name: conductor.security.okta.sync.enabled
              value: "true"
            {{- if .Values.security.okta.sync.frequency }}
            - name: conductor.security.okta.sync.frequency
              value: {{ .Values.security.okta.sync.frequency | quote }}
            {{- end }}
            - name: conductor.security.okta.sync.org
              value: {{ .Values.security.okta.sync.org }}
            - name: conductor.security.okta.sync.clientId
              value: {{ .Values.security.okta.sync.clientId }}
            {{- end }}
            {{- end }}
            {{- end }}
            #### Archive ####
            - name: conductor.archive.db.document.store.type
              value: {{ .Values.app.archiveStoreType | quote }}
            - name: conductor.archive.db.document.store.s3.region
              value: {{ .Values.app.s3Region }}
            - name: conductor.archive.db.document.store.uploader.threadCount
              value: {{ .Values.app.documentStoreUploaderThreadCount | quote }}
            - name: conductor.archive.db.indexer.threadCount
              value: {{ .Values.app.dbIndexerThreadCount | quote }}
            - name: conductor.archive.db.indexer.pollingInterval
              value: {{ .Values.app.dbIndexerPollingInterval | quote }}
            {{- if eq .Values.app.archiveStoreType "s3" }}
            - name: conductor.archive.db.document.store.s3.s3BucketName
              value: {{ .Values.app.documentStoreS3BucketName | quote }}
            {{- end }}
            {{- if eq .Values.app.archiveStoreType "azureblob" }}
            - name: conductor.archive.db.document.store.type.azureblob.containerName
              value: {{ .Values.app.documentStoreAzureBlobContainerName | quote }}
            - name: conductor.archive.db.document.store.type.azureblob.endpoint
              value: {{ .Values.app.documentStoreAzureBlobEndpoint | quote }}
            - name: conductor.archive.db.document.store.type.azureblob.useSASToken
              value: {{ .Values.app.documentStoreAzureUseSASToken | quote }}
            {{- end }}
            {{- if eq .Values.app.archiveStoreType "gcp" }}
            - name: conductor.archive.db.document.store.type.gcp.bucketName
              value: {{ .Values.app.documentStoreGcpBucketName | quote }}
            - name: conductor.archive.db.document.store.type.gcp.location
              value: {{ .Values.app.documentStoreGcpLocation | quote }}
            {{- end }}
            - name: conductor.archive.db.indexer.pollBatchSize
              value: {{ .Values.app.dbIndexerPollBatchSize | quote }}
            #### Sweeper ####
            - name: conductor.app.sweeper.sweepBatchSize
              value: {{ .Values.app.sweepBatchSize | quote }}
            - name: conductor.app.sweeperThreadCount
              value: {{ .Values.app.sweeperThreadCount | quote }}
            - name: conductor.sweep-frequency.millis
              value: {{ .Values.app.sweepFrequencyMillis | quote }}
            #### Scheduler ####
            - name: conductor.scheduler.pollBatchSize
              value: {{ .Values.app.schedulerPollBatchSize | quote }}
            - name: conductor.scheduler.pollingInterval
              value: {{ .Values.app.schedulerPollingInterval | quote }}
            #### Secrets ####
            - name: conductor.secrets.type
              value: {{ $secretsType | quote }}
            {{- if .Values.secrets.ssmPath }}
            - name: conductor.secrets.ssm.path
              value: {{ .Values.secrets.ssmPath | quote }}
            {{- end }}
            {{- if .Values.secrets.gsmPath }}
            - name: conductor.secrets.gsm.path
              value: {{ .Values.secrets.gsmPath | quote }}
            {{- end }}
            #### Limits ####
            - name: conductor.limits.maxWorkflowSizeInMiB
              value: {{ .Values.app.limits.maxWorkflowSizeInMiB | quote }}
            - name: conductor.limits.maxTaskSizeInKiB
              value: {{ .Values.app.limits.maxTaskSizeInKiB | quote }}
            - name: conductor.limits.maxTaskInWorkflowExecution
              value: {{ .Values.app.limits.maxTaskInWorkflowExecution | quote }}
            - name: conductor.limits.maxTaskInWorkflowDefinition
              value: {{ .Values.app.limits.maxTaskInWorkflowDefinition | quote }}
            #### API Orchestration ####
            - name: conductor.api.orchestration.enabled
              value: {{ .Values.app.apiOrchestrationEnabled | quote }}
            #### gRPC Server for Conductor's own APIs ####
            - name: conductor.grpc.enabled
              value: {{ .Values.app.grpcServerEnabled | quote }}
            #### Others ####
            - name: conductor.postgres.workflowDefCacheRefreshInterval
              value: {{ .Values.app.workflowDefinitionCache.refreshIntervalInSeconds | quote }}
            - name: conductor.postgres.workflowDefCacheMaxSize
              value: {{ .Values.app.workflowDefinitionCache.maxSize | quote }}
            - name: conductor.postgres.taskDefCacheRefreshInterval
              value: {{ .Values.app.taskDefinitionCache.refreshIntervalInSeconds | quote }}
            - name: conductor.postgres.taskDefCacheMaxSize
              value: {{ .Values.app.taskDefinitionCache.maxSize | quote }}
            - name: conductor.swagger.url
              value: {{ .Values.app.swaggerUrl | quote }}
            - name: conductor.app.lockTimeToTry
              value: {{ .Values.app.lockTimeToTry | quote }}
            - name: conductor.app.systemTaskMaxPollCount
              value: {{ .Values.app.systemTaskMaxPollCount | quote }}
            - name: conductor.app.workflow-execution-lock-enabled
              value: {{ .Values.app.workflowExecutionLockEnabled | quote }}
            - name: conductor.api.ratelimiter.enabled
              value: {{ .Values.app.apiRateLimiterEnabled | quote }}
            - name: conductor.human-task.enabled
              value: {{ .Values.app.humanTasksEnabled | default "false" | quote }}
            - name: conductor.app.workflow.introspection.enabled
              value: {{ .Values.app.workflowIntrospection.enabled | default "false" | quote }}
            - name: conductor.app.workflow.introspection.recordExpirationInSeconds
              value: {{ .Values.app.workflowIntrospection.recordExpirationInSeconds | default 86400 | quote }}
            - name: conductor.app.workflow.introspection.batchInsertIntervalInMillis
              value: {{ .Values.app.workflowIntrospection.batchInsertIntervalInMillis | default 1000 | quote }}
            - name: LOCAL_HOST_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            {{- if .Values.conductor.env }}
            {{- range $key, $value := .Values.conductor.env }}
            - name: {{ $key }}
              value: {{ $value | quote }}
            {{- end }}
            {{- end }}
          name: {{ .Chart.Name }}
          image: "{{ include "orkes-conductor.server.image.repository" . }}:{{ include "orkes-conductor.server.image.tag" . }}"
          imagePullPolicy: {{ include "orkes-conductor.server.image.pullPolicy" . }}
          ports:
            - name: liveness-port
              containerPort: {{ .Values.server.livenessPort | default .Values.image.livenessPort }}
              protocol: TCP
          resources:
            limits:
              cpu: {{ .Values.app.resources.cpuLimit | quote }}
              memory: {{ .Values.app.resources.memoryLimit | quote }}
            requests:
              cpu: {{ .Values.app.resources.cpuRequests | quote }}
              memory: {{ .Values.app.resources.memoryRequests | quote }}
          startupProbe:
            httpGet:
              path: /health
              port: liveness-port
            failureThreshold: 30
            periodSeconds: 10
      imagePullSecrets:
        {{- include "orkes-conductor.imagePullSecrets" . | nindent 8 }}
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      serviceAccount: {{ include "orkes-conductor.vault.server.serviceAccount" . }}
      serviceAccountName: {{ include "orkes-conductor.vault.server.serviceAccount" . }}
      terminationGracePeriodSeconds: 30
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "orkes-conductor-workers.fullname" . }}
spec:
  progressDeadlineSeconds: 600
  replicas: {{ $workersReplicas }}
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: {{ include "orkes-conductor-workers.fullname" . }}
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    type: RollingUpdate
  template:
    metadata:
      annotations:
        prometheus.io/path: /actuator/prometheus
        prometheus.io/port: "8085"
        prometheus.io/scrape: "true"
        {{- $vaultWorkersEnabled := or (and .Values.global.vault.enabled .Values.global.vault.workers.enabled) (and .Values.vault.enabled .Values.vault.workers.enabled) -}}
        {{- if $vaultWorkersEnabled }}
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/agent-inject-status: "update"
        vault.hashicorp.com/role: {{ include "orkes-conductor.vault.workers.role" . | quote }}
        vault.hashicorp.com/agent-pre-populate-only: "false"
        {{- $mergedWorkersEnvSecrets := include "orkes-conductor.vault.workers.getMergedEnvSecrets" . | fromYaml -}}
        {{- range $envVar, $secretPath := $mergedWorkersEnvSecrets }}
        {{- $parts := splitList "#" $secretPath }}
        {{- $path := index $parts 0 }}
        {{- $key := index $parts 1 }}
        {{- $actualEnvVar := $envVar }}
        {{- if eq $envVar "ACCESS_KEY_ID" }}
          {{- $actualEnvVar = "conductor.security.client.key-id" }}
        {{- else if eq $envVar "ACCESS_KEY_SECRET" }}
          {{- $actualEnvVar = "conductor.security.client.secret" }}
        {{- else if eq $envVar "JWT_REFRESH_INTERVAL" }}
          {{- $actualEnvVar = "conductor.security.token.refresh.interval" }}
        {{- end }}
        vault.hashicorp.com/agent-inject-secret-{{ $envVar }}: {{ $path | quote }}
        vault.hashicorp.com/agent-inject-template-{{ $envVar }}: |
          {{`{{- with secret `}}{{ $path | quote }}{{` -}}
          export `}}{{ $actualEnvVar }}{{`="{{ .Data.data.`}}{{ $key }}{{` }}"
          {{- end -}}`}}
        {{- end }}
        {{- $mergedWorkersAnnotations := include "orkes-conductor.vault.workers.getMergedAnnotations" . | fromYaml -}}
        {{- if $mergedWorkersAnnotations }}
        {{- toYaml $mergedWorkersAnnotations | nindent 8 }}
        {{- end }}
        {{- end }}
      labels:
        app: {{ include "orkes-conductor-workers.fullname" . }}
    spec:
      containers:
        - env:
            - name: DEPLOY_ENV
              value: prod
            - name: aws.region
              value: {{ .Values.app.s3Region | quote }}
            - name: JVM_MEMORY_SETTINGS
              value: {{ .Values.workersConfig.jvmSettings | quote }}
            - name: SPRING_PROFILES_ACTIVE
              value: {{ printf "%s%s" (ternary "security," "" $securityEnabled) .Values.workersConfig.springProfilesActive | quote }}
            - name: conductor.worker.http.block.hosts
              value: localhost
            - name: conductor.worker.http.block.ips
              value: {{ .Values.workersConfig.blockIps | quote }}
            {{- if $enableCustomTrustStore }}
            - name: conductor.worker.http.customcerts.enabled
              value: "true"
            - name: conductor.worker.http.customcerts.path
              value: {{ printf "/app/certificates/%s" .Values.jksFileName | quote }}
            - name: conductor.worker.http.customcerts.password
              value: {{ .Values.jksFilePassword | quote }}
            {{- end }}
            {{- $overrideServerUrl := and .Values.workersConfig.env (hasKey .Values.workersConfig.env "conductor.server.url") -}}
            {{- if not $overrideServerUrl }}
            - name: conductor.server.url
              value: http://{{ include "orkes-conductor-server.fullname" . }}.{{ .Release.Namespace }}.svc.cluster.local:5000/api/
            {{- end }}
            # Ensure workers can resolve GSM/SSM placeholders like ${gsm:...}
            - name: conductor.secrets.type
              value: {{ $secretsType | quote }}
            {{- if $securityEnabled }}
            {{- $vaultWorkersEnabled := or (and .Values.global.vault.enabled .Values.global.vault.workers.enabled) (and .Values.vault.enabled .Values.vault.workers.enabled) -}}
            {{- if and $vaultWorkersEnabled (include "orkes-conductor.vault.workers.hasEnvSecret" (dict "root" . "key" "ACCESS_KEY_ID")) }}
            {{- /* ACCESS_KEY_ID will be injected from Vault */ -}}
            {{- else }}
            - name: conductor.security.client.key-id
              value: {{ include "orkes-conductor.workers.accessKeyId" . | quote }}
            {{- end }}
            {{- if and $vaultWorkersEnabled (include "orkes-conductor.vault.workers.hasEnvSecret" (dict "root" . "key" "ACCESS_KEY_SECRET")) }}
            {{- /* ACCESS_KEY_SECRET will be injected from Vault */ -}}
            {{- else }}
            - name: conductor.security.client.secret
              value: {{ include "orkes-conductor.workers.accessKeySecret" . | quote }}
            {{- end }}
            {{- if .Values.security.jwtExpiry }}
            {{- if and $vaultWorkersEnabled (include "orkes-conductor.vault.workers.hasEnvSecret" (dict "root" . "key" "JWT_REFRESH_INTERVAL")) }}
            {{- /* JWT_REFRESH_INTERVAL will be injected from Vault */ -}}
            {{- else }}
            - name: conductor.security.token.refresh.interval
              value: {{ .Values.security.jwtExpiry | quote }}
            {{- end }}
            {{- end }}
            {{- end }}
            - name: LOCAL_HOST_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            {{- if .Values.workersConfig.env }}
            {{- range $key, $value := .Values.workersConfig.env }}
            - name: {{ $key }}
              value: {{ $value | quote }}
            {{- end }}
            {{- end }}
          image: "{{ include "orkes-conductor.workers.image.repository" . }}:{{ include "orkes-conductor.workers.image.tag" . }}"
          imagePullPolicy: {{ include "orkes-conductor.workers.image.pullPolicy" . }}
          {{- if $enableCustomTrustStore }}
          volumeMounts:
            - name: custom-truststore-vol
              mountPath: {{ printf "/app/certificates/%s" .Values.jksFileName | quote }}
              subPath: {{ .Values.jksFileName | quote }}
          {{- end }}
          name: {{ include "orkes-conductor-workers.fullname" . }}
          resources:
            limits:
              cpu: {{ .Values.workersConfig.resources.cpuLimit | quote }}
              memory: {{ .Values.workersConfig.resources.memoryLimit | quote }}
            requests:
              cpu: {{ .Values.workersConfig.resources.cpuRequests | quote }}
              memory: {{ .Values.workersConfig.resources.memoryRequests | quote }}
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
      dnsPolicy: ClusterFirst
      {{- if $enableCustomTrustStore }}
      volumes:
        - name: custom-truststore-vol
          configMap:
            name: "custom-truststore-cm"
            items:
              - key: {{ .Values.jksFileName | quote }}
                path: {{ .Values.jksFileName | quote }}
      {{- end }}
      imagePullSecrets:
        {{- include "orkes-conductor.imagePullSecrets" . | nindent 8 }}
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      serviceAccount: {{ include "orkes-conductor.vault.workers.serviceAccount" . }}
      serviceAccountName: {{ include "orkes-conductor.vault.workers.serviceAccount" . }}
      terminationGracePeriodSeconds: 30

apiVersion: v1
kind: ServiceAccount
metadata:
  name: conductor-app
  labels:
    {{- include "orkes-conductor.labels" . | nindent 4 }}
  annotations:
    {{- $gsa := "" -}}
    {{- if and .Values.serviceAccount .Values.serviceAccount.annotations -}}
      {{- $flat := (index .Values.serviceAccount.annotations "iam.gke.io/gcp-service-account") -}}
      {{- if $flat -}}{{- $gsa = $flat -}}{{- end -}}
      {{- if and (not $gsa) .Values.serviceAccount.annotations.iam .Values.serviceAccount.annotations.iam.gke -}}
        {{- $nested := (index .Values.serviceAccount.annotations.iam.gke "io/gcp-service-account") -}}
        {{- if $nested -}}{{- $gsa = $nested -}}{{- end -}}
      {{- end -}}
    {{- end -}}
    {{- if $gsa }}
    iam.gke.io/gcp-service-account: {{ $gsa | quote }}
    {{- end }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: conductor-workers-app
  labels:
    {{- include "orkes-conductor.labels" . | nindent 4 }}
  annotations:
    {{- $gsa := "" -}}
    {{- if and .Values.serviceAccount .Values.serviceAccount.annotations -}}
      {{- $flat := (index .Values.serviceAccount.annotations "iam.gke.io/gcp-service-account") -}}
      {{- if $flat -}}{{- $gsa = $flat -}}{{- end -}}
      {{- if and (not $gsa) .Values.serviceAccount.annotations.iam .Values.serviceAccount.annotations.iam.gke -}}
        {{- $nested := (index .Values.serviceAccount.annotations.iam.gke "io/gcp-service-account") -}}
        {{- if $nested -}}{{- $gsa = $nested -}}{{- end -}}
      {{- end -}}
    {{- end -}}
    {{- if $gsa }}
    iam.gke.io/gcp-service-account: {{ $gsa | quote }}
    {{- end }}
